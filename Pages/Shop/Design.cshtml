@page
@model MagyarGravir.Shop.Pages.Shop.DesignModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Egyedi tervez√©s ‚Äì " + (Model.Product?.Name ?? "");
}

<section class="mg-section designer-hero">
    <div class="designer-headline">
        <span class="designer-pill">Egyedi tervez≈ë</span>
        <h1>@Model.Product?.Name ‚Äì saj√°t felirattal vagy k√©ppel</h1>
        <p>
            V√°laszd ki, hogy <strong>feliratot</strong> vagy <strong>k√©pet</strong> szeretn√©l, √©s n√©zd meg azonnal,
            hogyan mutatna a p√©nzcsipeszen / term√©ken. A tervet a rendszer elmenti a rendel√©shez.
        </p>
    </div>
</section>

<section class="designer-main">
    <div class="designer-preview-card">
        <div class="designer-preview-inner">
            <div class="designer-preview-header">
                <div class="designer-chip">√âl≈ë el≈ën√©zet</div>
                <span class="designer-hint">Fogd meg √©s mozgasd a feliratot vagy a k√©pet a grav√≠rozhat√≥ fel√ºleten.</span>
            </div>

            <div class="designer-moneyclip-frame">
                @* Alapk√©p ‚Äì itt jelenik meg a p√©nzcsipesz fot√≥ja *@
                @if (!string.IsNullOrEmpty(Model.Product?.MainImagePath))
                {
                    <img src="@Model.Product.MainImagePath" class="moneyclip-base" alt="@Model.Product.Name" />
                }
                else
                {
                    <img src="~/header-big.png" class="moneyclip-base" alt="P√©nzcsipesz el≈ën√©zet" />
                }

                <div id="overlayZone" class="overlay-zone">
                    <div id="overlayText" class="moneyclip-overlay-text draggable font-alexbrush">
                        @(Model.CustomText ?? Model.InitialText)
                    </div>
                    <img id="overlayImage" class="moneyclip-overlay-image draggable" style="display:none;" alt="Felt√∂lt√∂tt minta" />
                </div>
            </div>

            <div class="designer-preview-footer">
                <span>üí° Tipp: r√∂vid, t√∂m√∂r felirat, maximum 2‚Äì3 sorral mutat a legjobban.</span>
            </div>
        </div>
    </div>

    <div class="designer-form-card">
        <form method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="ProductId" />

            <div class="designer-mode-toggle">
                <label>
                    <input type="radio" name="DesignMode" value="text" @(Model.DesignMode == "text" ? "checked" : "") />
                    Csak felirat
                </label>
                <label>
                    <input type="radio" name="DesignMode" value="image" @(Model.DesignMode == "image" ? "checked" : "") />
                    Csak k√©p / log√≥
                </label>
            </div>

            <div id="textBlock">
                <label for="customTextInput">Felirat a grav√≠roz√°shoz:</label>
                <input asp-for="CustomText" id="customTextInput" placeholder="Pl. Befektet√ºnk ‚Äì kifektet√ºnk" />
                <span class="designer-help">
                    T√∂bb sor is megadhat√≥ ‚Äì soronk√©nt nyomj Entert.
                </span>

                <div class="designer-font-select">
                    Bet≈±t√≠pus:
                    <select id="fontSelector">
                        <option value="alex" selected>Alex Brush (k√©z√≠r√°s)</option>
                        <option value="cinzel">Cinzel (klasszikus)</option>
                        <option value="sans">Poppins (letisztult)</option>
                    </select>
                </div>
            </div>

            <div id="imageBlock" style="display:none;">
                <label for="uploadInput">K√©p felt√∂lt√©se (log√≥, grafika, fot√≥ ‚Äì JPG / PNG):</label>
                <input asp-for="UploadImage" type="file" accept="image/*" id="uploadInput" />
                <span class="designer-help">
                    A k√©p nem ker√ºl automatikusan gy√°rt√°sba, minden rendel√©s eset√©n egyeztetek veled a v√©gleges√≠t√©s el≈ëtt.
                </span>
            </div>

            <hr class="designer-divider" />

            <button type="submit" class="designer-submit">
                Kos√°rba ezzel az egyedi tervvel üõí
            </button>

            <p class="designer-small">
                A kos√°rban b√°rmikor m√≥dos√≠thatod vagy t√∂r√∂lheted a rendel√©st, miel≈ëtt v√©gleges√≠ted.
            </p>
        </form>
    </div>
</section>

@section Scripts {
<script>
    (function () {
        const modeRadios = document.querySelectorAll('input[name="DesignMode"]');
        const textBlock = document.getElementById('textBlock');
        const imageBlock = document.getElementById('imageBlock');
        const textInput = document.getElementById('customTextInput');
        const overlayText = document.getElementById('overlayText');
        const uploadInput = document.getElementById('uploadInput');
        const overlayImage = document.getElementById('overlayImage');
        const fontSelector = document.getElementById('fontSelector');
        const overlayZone = document.getElementById('overlayZone');

        function updateMode() {
            const selected = document.querySelector('input[name="DesignMode"]:checked')?.value || 'text';
            if (selected === 'text') {
                textBlock.style.display = 'block';
                imageBlock.style.display = 'none';
                overlayText.style.display = 'flex';
                overlayImage.style.display = 'none';
            } else {
                textBlock.style.display = 'none';
                imageBlock.style.display = 'block';
                overlayText.style.display = 'none';
                overlayImage.style.display = 'block';
            }
        }

        modeRadios.forEach(r => r.addEventListener('change', updateMode));
        updateMode();

        if (textInput && overlayText) {
            textInput.addEventListener('input', function () {
                const v = this.value;
                overlayText.textContent = v && v.trim().length > 0
                    ? v
                    : "@Model.InitialText";
            });
        }

        if (fontSelector && overlayText) {
            fontSelector.addEventListener('change', function () {
                overlayText.classList.remove('font-alexbrush', 'font-cinzel', 'font-sans');
                if (this.value === 'alex') overlayText.classList.add('font-alexbrush');
                else if (this.value === 'cinzel') overlayText.classList.add('font-cinzel');
                else overlayText.classList.add('font-sans');
            });
        }

        if (uploadInput && overlayImage) {
            uploadInput.addEventListener('change', function (evt) {
                const file = evt.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    overlayImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function makeDraggable(el) {
            if (!el) return;
            el.addEventListener('mousedown', function (e) {
                e.preventDefault();

                const zoneRect = overlayZone.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();

                const shiftX = e.clientX - elRect.left;
                const shiftY = e.clientY - elRect.top;

                function moveAt(pageX, pageY) {
                    let newLeft = pageX - shiftX - zoneRect.left;
                    let newTop = pageY - shiftY - zoneRect.top;

                    newLeft = Math.max(0, Math.min(newLeft, zoneRect.width - el.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, zoneRect.height - el.offsetHeight));

                    el.style.left = newLeft + "px";
                    el.style.top = newTop + "px";
                }

                function onMouseMove(ev) {
                    moveAt(ev.pageX, ev.pageY);
                }

                document.addEventListener('mousemove', onMouseMove);

                document.addEventListener('mouseup', function mouseUpHandler() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', mouseUpHandler);
                });
            });

            el.ondragstart = function () { return false; };
        }

        makeDraggable(overlayText);
        makeDraggable(overlayImage);
    })();
</script>
}
